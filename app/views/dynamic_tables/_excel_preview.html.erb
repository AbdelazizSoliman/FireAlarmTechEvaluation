<%= form_with url: admin_create_main_tables_path, method: :post, data: { turbo: false }, id: 'excel-preview-form' do |form| %>
  <table class="table-auto border-collapse border w-full text-center">
    <% @grid.each_with_index do |row, i| %>
      <tr>
        <% row.each_with_index do |cell, j| %>
          <% if cell[:col].present? && cell[:row].present? %>
            <% ref = ("A".ord + cell[:col].to_i - 1).chr + cell[:row].to_s %>
          <% else %>
            <% ref = "" %>
          <% end %>
          <% if j == 0 %>
            <td
              data-ref="<%= ref %>"
              data-value="<%= cell[:value] %>"
              data-row="<%= cell[:row] %>"
              class="border px-2 py-1 cursor-pointer select-none first-col-cell"
              onclick="selectExcelCell(this)"
              style="background-color: #f0fdf4; position:relative;"
            >
              <span
                class="select-icon"
                style="font-size: 1.2em; margin-right:4px; vertical-align:middle;"
              >
                &#x25CB;
              </span>
              <span class="cell-value"><%= cell[:value] %></span>
            </td>
          <% else %>
            <td data-ref="<%= ref %>" class="border px-2 py-1 select-none">
              <%= cell[:value] %>
            </td>
          <% end %>
        <% end %>
      </tr>
    <% end %>
  </table>

  <input
    type="hidden"
    name="selected_cell_value"
    id="selected_cell_value"
    value=""
  />
  <input
    type="hidden"
    name="selected_cell_row"
    id="selected_cell_row"
    value=""
  />
  <input type="hidden" name="excel_action" id="excel_action" value="" />

  <div class="mt-4 text-right flex justify-end space-x-2">
    <button
      type="button"
      onclick="submitExcelAction('main')"
      class="inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 opacity-100"
    >
      Create Main Tables
    </button>
    <button
      type="button"
      onclick="submitExcelAction('child')"
      class="inline-block px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 opacity-100"
    >
      Create Child Tables
    </button>
    <button
      type="button"
      onclick="submitExcelAction('feature')"
      class="inline-block px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 opacity-100"
    >
      Create Features
    </button>
  </div>
<% end %>

<script>
  function selectExcelCell(td) {
    // Unselect all
    document.querySelectorAll(".first-col-cell").forEach((cell) => {
      cell.style.backgroundColor = "#f0fdf4";
      var icon = cell.querySelector(".select-icon");
      if (icon) icon.innerHTML = "&#x25CB;"; // Empty circle
    });
    // Select this cell
    td.style.backgroundColor = "#bbf7d0";
    var selectedIcon = td.querySelector(".select-icon");
    if (selectedIcon) selectedIcon.innerHTML = "&#x25C9;"; // Filled circle
    document.getElementById("selected_cell_value").value = td.getAttribute(
      "data-value"
    );
    document.getElementById("selected_cell_row").value = td.getAttribute(
      "data-row"
    );
  }

  function submitExcelAction(actionType) {
    document.getElementById("excel_action").value = actionType;
    const form = document.getElementById("excel-preview-form");
    if (!document.getElementById("selected_cell_value").value) {
      alert("Please select a cell from the first column.");
      return;
    }
    switch (actionType) {
      case "main":
        form.action = "<%= admin_create_main_tables_path %>";
        break;
      case "child":
        form.action = "<%= admin_create_child_tables_path %>";
        break;
      case "feature":
        form.action = "<%= admin_create_features_path %>";
        break;
    }
    form.submit();
  }
</script>
