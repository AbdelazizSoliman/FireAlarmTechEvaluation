<!-- app/views/dynamic_tables/admin.html.erb -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Database Management</title>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">
  <div class="max-w-5xl mx-auto py-12 px-4">

    <!-- Flash Messages -->
    <% if flash[:success] %>
      <div class="mb-6 p-4 bg-green-50 border-l-4 border-green-500">
        <%= flash[:success] %>
      </div>
    <% elsif flash[:error] %>
      <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500">
        <%= flash[:error] %>
      </div>
    <% end %>

    <h1 class="text-3xl font-bold mb-6">Database Management - Admin Panel</h1>

    <!-- Step 1: Filter (Project, Discipline, System, Subsystem) -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold">1. Select Project / Discipline / System / Subsystem</h2>
      <form action="/admin" method="get" class="space-y-6 mt-4">
        <!-- Project Filter -->
        <div>
          <label for="project_filter" class="block text-sm font-medium">Project</label>
          <select id="project_filter" name="project_filter" onchange="this.form.submit()" class="mt-1 block w-full">
            <option value="">-- Choose a Project --</option>
            <% @projects.each do |name, id| %>
              <option value="<%= id %>" <%= "selected" if params[:project_filter] == id.to_s %>><%= name %></option>
            <% end %>
          </select>
        </div>

        <!-- Project Discipline Filter -->
        <% if @project_filter.present? %>
          <div>
            <label for="project_scope_filter" class="block text-sm font-medium">Project Discipline</label>
            <select id="project_scope_filter" name="project_scope_filter" onchange="this.form.submit()" class="mt-1 block w-full">
              <option value="">-- Choose a Project Discipline --</option>
              <% @project_scopes.each do |name, id| %>
                <option value="<%= id %>" <%= "selected" if @project_scope_filter == id.to_s %>><%= name %></option>
              <% end %>
            </select>
          </div>
        <% end %>

        <!-- System Filter -->
        <% if @project_scope_filter.present? %>
          <div>
            <label for="system_filter" class="block text-sm font-medium">System</label>
            <select id="system_filter" name="system_filter" onchange="this.form.submit()" class="mt-1 block w-full">
              <option value="">-- Choose a System --</option>
              <% @systems.each do |name, id| %>
                <option value="<%= id %>" <%= "selected" if @system_filter == id.to_s %>><%= name %></option>
              <% end %>
            </select>
          </div>
        <% end %>

        <!-- Subsystem Filter -->
        <% if @system_filter.present? %>
          <div>
            <label for="subsystem_filter" class="block text-sm font-medium">Subsystem</label>
            <select id="subsystem_filter" name="subsystem_filter" onchange="this.form.submit()" class="mt-1 block w-full">
              <option value="">-- Choose a Subsystem --</option>
              <% @subsystems.each do |name, id| %>
                <option value="<%= id %>" <%= "selected" if @subsystem_filter == id.to_s %>><%= name %></option>
              <% end %>
            </select>
          </div>
        <% end %>
      </form>
    </section>

    <!-- Show table management forms only if a subsystem is selected -->
    <% if @subsystem_filter.present? %>
      <!-- 2. Create Main Table -->
      <section class="mb-8">
  <h2 class="text-xl font-semibold cursor-pointer mb-2"
      onclick="toggleSection('create-main-table-form')">
    Create New Main Table(s)
  </h2>

  <div id="create-main-table-form" class="hidden p-6 bg-white rounded shadow">
    <!-- We post to our new create_multiple_tables action -->
    <form action="/admin/create_multiple_tables" method="post" class="space-y-4">

      <!-- Keep filter params so we redirect back with them -->
      <input type="hidden" name="project_filter" value="<%= @project_filter %>">
      <input type="hidden" name="project_scope_filter" value="<%= @project_scope_filter %>">
      <input type="hidden" name="system_filter" value="<%= @system_filter %>">
      <input type="hidden" name="subsystem_filter" value="<%= @subsystem_filter %>">

      <!-- Subsystem ID -->
      <div>
        <label for="subsystem_id_main" class="block text-sm font-medium text-gray-700 mb-1">
          Subsystem
        </label>
        <select id="subsystem_id_main" name="subsystem_id"
                class="mt-1 block w-full border-gray-300 rounded shadow-sm"
                required>
          <% @subsystems.each do |name, id| %>
            <option value="<%= id %>" <%= "selected" if @subsystem_filter == id.to_s %>><%= name %></option>
          <% end %>
        </select>
      </div>

      <!-- Container for multiple table name inputs -->
      <div id="main-tables-container" class="space-y-2">
        <div class="table-row flex flex-col sm:flex-row sm:items-center sm:space-x-4">
          <label class="block text-sm font-medium text-gray-700 sm:w-1/4">
            Table Name
          </label>
          <input type="text" name="table_names[]"
                 placeholder="e.g. product_data"
                 class="mt-1 sm:mt-0 flex-1 border-gray-300 rounded shadow-sm"
                 required />
        </div>
      </div>

      <!-- Button to add more table rows -->
      <button type="button"
              class="inline-flex items-center px-3 py-2 bg-blue-100 text-blue-800 rounded hover:bg-blue-200"
              onclick="addTableRow()">
        + Add New Table
      </button>

      <!-- Submit button -->
      <button type="submit"
              class="mt-4 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
        Create Main Table(s)
      </button>
    </form>
  </div>
</section>

      <!-- 3. Create Sub Table -->
      <section class="mb-8">
        <h2 class="text-xl font-semibold cursor-pointer" onclick="toggleSection('create-sub-table-form')">
          3. Create New Sub Table
        </h2>
        <div id="create-sub-table-form" class="hidden mt-2 p-4 bg-white rounded shadow">
          <form action="/admin/create_sub_table" method="post">
            <!-- Keep filter params -->
            <input type="hidden" name="project_filter" value="<%= @project_filter %>">
            <input type="hidden" name="project_scope_filter" value="<%= @project_scope_filter %>">
            <input type="hidden" name="system_filter" value="<%= @system_filter %>">
            <input type="hidden" name="subsystem_filter" value="<%= @subsystem_filter %>">

            <div>
              <label for="subsystem_id_sub" class="block text-sm font-medium">Subsystem</label>
              <select id="subsystem_id_sub" name="subsystem_id" required class="mt-1 block w-full">
                <% @subsystems.each do |name, id| %>
                  <option value="<%= id %>" <%= "selected" if @subsystem_filter == id.to_s %>><%= name %></option>
                <% end %>
              </select>
            </div>
            <div class="mt-4">
              <label for="parent_table" class="block text-sm font-medium">Select Parent Table</label>
              <select id="parent_table" name="parent_table" required class="mt-1 block w-full">
                <% @main_tables.each do |td| %>
                  <option value="<%= td.table_name %>"><%= td.table_name.humanize %></option>
                <% end %>
              </select>
            </div>
            <div class="mt-4">
              <label for="sub_table_name" class="block text-sm font-medium">Sub-Table Name</label>
              <input type="text" id="sub_table_name" name="sub_table_name" required placeholder="e.g., product_variants" class="mt-1 block w-full">
            </div>
            <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded">
              Create Sub Table
            </button>
          </form>
        </div>
      </section>

      <!-- 4. Add Column / Feature -->
      <section class="mb-8">
        <h2 class="text-xl font-semibold cursor-pointer" onclick="toggleSection('add-column-form')">
          4. Add Feature / Column
        </h2>
        <div id="add-column-form" class="hidden mt-2 p-4 bg-white rounded shadow">
          <form action="/admin/add_column" method="post" class="space-y-6">
            <!-- Keep filter params -->
            <input type="hidden" name="project_filter" value="<%= @project_filter %>">
            <input type="hidden" name="project_scope_filter" value="<%= @project_scope_filter %>">
            <input type="hidden" name="system_filter" value="<%= @system_filter %>">
            <input type="hidden" name="subsystem_filter" value="<%= @subsystem_filter %>">

            <div>
              <label for="table_name_select" class="block text-sm font-medium">Select Table</label>
              <select id="table_name_select" name="table_name" required class="mt-1 block w-full">
                <optgroup label="Main Tables">
                  <% @main_tables.each do |td| %>
                    <option value="<%= td.table_name %>" <%= "selected" if @table_name == td.table_name %>><%= td.table_name.humanize %></option>
                  <% end %>
                </optgroup>
                <optgroup label="Sub Tables">
                  <% @sub_tables.each do |td| %>
                    <option value="<%= td.table_name %>" <%= "selected" if @table_name == td.table_name %>><%= td.table_name.humanize %></option>
                  <% end %>
                </optgroup>
              </select>
            </div>

            <div>
              <label for="column_name" class="block text-sm font-medium">Feature Name</label>
              <input type="text" id="column_name" name="column_name" required placeholder="e.g., category" class="mt-1 block w-full">
            </div>

            <div>
              <label for="column_type" class="block text-sm font-medium">Feature Type</label>
              <select id="column_type" name="column_type" required class="mt-1 block w-full">
                <option value="string">String</option>
                <option value="integer">Integer</option>
                <option value="boolean">Boolean</option>
                <option value="decimal">Decimal</option>
                <option value="text">Text</option>
                <option value="text[]">Text Array</option>
                <option value="date">Date</option>
              </select>
            </div>

            <!-- Additional metadata fields for combobox/checkbox/cost (same as before) -->

            <button type="submit" class="w-full bg-indigo-600 text-white py-2">
              Add Feature
            </button>
          </form>
        </div>
      </section>

      <!-- Show existing columns if a table_name is selected -->
      <% if @table_name.present? %>
        <section class="mb-8">
          <h3 class="text-lg font-semibold">
            Existing Features in <%= @table_name.humanize %>
          </h3>
          <% if @existing_columns.any? %>
            <table class="min-w-full mt-4">
              <thead class="bg-indigo-600 text-white">
                <tr>
                  <th class="px-6 py-3">Feature Name</th>
                  <th class="px-6 py-3">Type</th>
                  <th class="px-6 py-3">Metadata</th>
                  <th class="px-6 py-3">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white">
                <% @existing_columns.each do |col| %>
                  <tr>
                    <td class="px-6 py-4"><%= col[:name] %></td>
                    <td class="px-6 py-4"><%= col[:type] %></td>
                    <td class="px-6 py-4"><%= col[:metadata] ? "Set" : "Not Set" %></td>
                    <td class="px-6 py-4">
                      <%= link_to "Edit Metadata", edit_metadata_dynamic_tables_path(
                        table_name: @table_name,
                        column_name: col[:name],
                        project_filter: @project_filter,
                        project_scope_filter: @project_scope_filter,
                        system_filter: @system_filter,
                        subsystem_filter: @subsystem_filter
                      ), class: "text-indigo-600" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-sm mt-4">No columns found for this table.</p>
          <% end %>
        </section>
      <% end %>
    <% else %>
      <!-- If no subsystem selected yet -->
      <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700">
        <p>Please select a Project, Discipline, System, and Subsystem first.</p>
      </div>
    <% end %>
  </div>

  <script>
  function toggleSection(id) {
    document.getElementById(id).classList.toggle('hidden');
  }

  function addTableRow() {
    const container = document.getElementById('main-tables-container');

    // Create a wrapper for the new row
    const row = document.createElement('div');
    row.classList.add('table-row', 'flex', 'flex-col', 'sm:flex-row', 'sm:items-center', 'sm:space-x-4', 'mt-2');

    // Build the HTML for a new input row
    row.innerHTML = `
      <label class="block text-sm font-medium text-gray-700 sm:w-1/4">
        Table Name
      </label>
      <input type="text" name="table_names[]" placeholder="e.g. product_data"
             class="mt-1 sm:mt-0 flex-1 border-gray-300 rounded shadow-sm" required />
    `;

    container.appendChild(row);
  }
</script>

</body>
</html>
