<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Database Management</title>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">
  <div class="max-w-5xl mx-auto py-12 px-4">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold">Database Management - Admin Panel</h1>
      <p class="mt-2 text-sm">Manage tables, sub-tables, and features dynamically</p>
    </header>

    <!-- Flash Messages -->
    <% if flash[:success] %>
      <div class="mb-6 p-4 bg-green-50 border-l-4 border-green-500 text-green-700 rounded">
        <%= flash[:success] %>
      </div>
    <% elsif flash[:error] %>
      <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded">
        <%= flash[:error] %>
      </div>
    <% end %>

    <!-- Filter Section -->
    <section class="mb-8 p-4 bg-white rounded shadow">
      <h2 class="text-xl font-semibold mb-2">1. Select Project / Discipline / System / Subsystem</h2>
      <form action="/admin" method="get" class="space-y-4">
        <!-- Project -->
        <div>
          <label for="project_filter" class="block text-sm font-medium">Project</label>
          <select id="project_filter" name="project_filter" onchange="this.form.submit()" class="mt-1 block w-full border-gray-300 rounded">
            <option value="">-- Choose a Project --</option>
            <% @projects.each do |name, id| %>
              <option value="<%= id %>" <%= "selected" if params[:project_filter] == id.to_s %>><%= name %></option>
            <% end %>
          </select>
        </div>
        <!-- Project Discipline -->
        <% if @project_filter.present? %>
          <div>
            <label for="project_scope_filter" class="block text-sm font-medium">Project Discipline</label>
            <select id="project_scope_filter" name="project_scope_filter" onchange="this.form.submit()" class="mt-1 block w-full border-gray-300 rounded">
              <option value="">-- Choose a Discipline --</option>
              <% @project_scopes.each do |name, id| %>
                <option value="<%= id %>" <%= "selected" if params[:project_scope_filter] == id.to_s %>><%= name %></option>
              <% end %>
            </select>
          </div>
        <% end %>
        <!-- System -->
        <% if @project_scope_filter.present? %>
          <div>
            <label for="system_filter" class="block text-sm font-medium">System</label>
            <select id="system_filter" name="system_filter" onchange="this.form.submit()" class="mt-1 block w-full border-gray-300 rounded">
              <option value="">-- Choose a System --</option>
              <% @systems.each do |name, id| %>
                <option value="<%= id %>" <%= "selected" if params[:system_filter] == id.to_s %>><%= name %></option>
              <% end %>
            </select>
          </div>
        <% end %>
        <!-- Subsystem -->
        <% if @system_filter.present? %>
          <div>
            <label for="subsystem_filter" class="block text-sm font-medium">Subsystem</label>
            <select id="subsystem_filter" name="subsystem_filter" onchange="this.form.submit()" class="mt-1 block w-full border-gray-300 rounded">
              <option value="">-- Choose a Subsystem --</option>
              <% @subsystems.each do |name, id| %>
                <option value="<%= id %>" <%= "selected" if params[:subsystem_filter] == id.to_s %>><%= name %></option>
              <% end %>
            </select>
          </div>
        <% end %>
      </form>
    </section>

    <% if @subsystem_filter.present? %>
      <!-- Section 2: Create New Main Table(s) -->
      <section class="mb-8">
        <h2 class="text-xl font-semibold cursor-pointer mb-2" onclick="toggleSection('create-main-table-form')">
          + Add New Main Table(s)
        </h2>
        <div id="create-main-table-form" class="hidden p-6 bg-white rounded shadow">
          <form action="/admin/create_multiple_tables" method="post" class="space-y-4">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <!-- Pass filter parameters -->
            <input type="hidden" name="project_filter" value="<%= @project_filter %>">
            <input type="hidden" name="project_scope_filter" value="<%= @project_scope_filter %>">
            <input type="hidden" name="system_filter" value="<%= @system_filter %>">
            <input type="hidden" name="subsystem_filter" value="<%= @subsystem_filter %>">
            <!-- Subsystem selection -->
            <div>
              <label for="subsystem_id_main" class="block text-sm font-medium">Subsystem</label>
              <select id="subsystem_id_main" name="subsystem_id" required class="mt-1 block w-full border-gray-300 rounded">
                <% @subsystems.each do |name, id| %>
                  <option value="<%= id %>" <%= "selected" if @subsystem_filter == id.to_s %>><%= name %></option>
                <% end %>
              </select>
            </div>
            <!-- Dynamic main table names input -->
            <div id="main-tables-container" class="space-y-2">
              <div class="table-row flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <label class="block text-sm font-medium text-gray-700 sm:w-1/4">Table Name</label>
                <input type="text" name="table_names[]" placeholder="e.g., product_data" required class="mt-1 sm:mt-0 flex-1 border-gray-300 rounded">
              </div>
            </div>
            <button type="button" onclick="addTableRow()" class="inline-flex items-center px-3 py-2 bg-blue-100 text-blue-800 rounded hover:bg-blue-200">
              + Add New Table
            </button>
            <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
              Create Main Table(s)
            </button>
          </form>
        </div>
      </section>

      <!-- Section 3: Create New Sub Table(s) -->
      <section class="mb-8">
        <h2 class="text-xl font-semibold cursor-pointer mb-2" onclick="toggleSection('create-sub-table-form')">
          + Add New Sub Table(s)
        </h2>
        <div id="create-sub-table-form" class="hidden p-6 bg-white rounded shadow">
          <form action="/admin/create_multiple_sub_tables" method="post" class="space-y-4">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <!-- Pass filter parameters -->
            <input type="hidden" name="project_filter" value="<%= @project_filter %>">
            <input type="hidden" name="project_scope_filter" value="<%= @project_scope_filter %>">
            <input type="hidden" name="system_filter" value="<%= @system_filter %>">
            <input type="hidden" name="subsystem_filter" value="<%= @subsystem_filter %>">
            <!-- Subsystem selection -->
            <div>
              <label for="subsystem_id_sub" class="block text-sm font-medium">Subsystem</label>
              <select id="subsystem_id_sub" name="subsystem_id" required class="mt-1 block w-full border-gray-300 rounded">
                <% @subsystems.each do |name, id| %>
                  <option value="<%= id %>" <%= "selected" if @subsystem_filter == id.to_s %>><%= name %></option>
                <% end %>
              </select>
            </div>
            <!-- Dynamic sub table rows: Each row has a Parent Table and Sub Table Name -->
            <div id="sub-tables-container" class="space-y-2">
              <div class="sub-table-row flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <div class="w-full sm:w-1/2">
                  <label class="block text-sm font-medium text-gray-700">Parent Table</label>
                  <select name="parent_tables[]" required class="mt-1 block w-full border-gray-300 rounded">
                    <% @main_tables.each do |td| %>
                      <option value="<%= td.table_name %>"><%= td.table_name.humanize %></option>
                    <% end %>
                  </select>
                </div>
                <div class="w-full sm:w-1/2">
                  <label class="block text-sm font-medium text-gray-700">Sub Table Name</label>
                  <input type="text" name="sub_table_names[]" placeholder="e.g., product_variants" required class="mt-1 block w-full border-gray-300 rounded">
                </div>
              </div>
            </div>
            <button type="button" onclick="addSubTableRow()" class="inline-flex items-center px-3 py-2 bg-blue-100 text-blue-800 rounded hover:bg-blue-200">
              + Add New Sub Table
            </button>
            <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
              Create Sub Table(s)
            </button>
          </form>
        </div>
      </section>

      <!-- Section 4: Add New Feature / Column(s) -->
      <section class="mb-8 p-4 bg-white rounded shadow">
  <h2 class="text-xl font-semibold mb-2">Add New Feature (Select Table, then Sub Table)</h2>

  <form action="/admin/add_column" method="post" class="space-y-4" onsubmit="syncFinalTableName()">
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

    <!-- Pass along any filter params so you stay on the same screen after creation -->
    <input type="hidden" name="project_filter" value="<%= @project_filter %>">
    <input type="hidden" name="project_scope_filter" value="<%= @project_scope_filter %>">
    <input type="hidden" name="system_filter" value="<%= @system_filter %>">
    <input type="hidden" name="subsystem_filter" value="<%= @subsystem_filter %>">

    <!-- We'll store the final chosen table in this hidden field -->
    <input type="hidden" id="final_table_name" name="table_name" value="">

    <!-- 1) Select Main Table -->
    <div>
      <label for="parent_table_select" class="block text-sm font-medium">Select Main Table</label>
      <select id="parent_table_select"
              name="parent_table"
              class="mt-1 block w-full border-gray-300 rounded"
              onchange="loadSubTables(this.value); syncFinalTableName();">
        <option value="">-- Choose a Main Table --</option>
        <% @main_tables.each do |td| %>
          <option value="<%= td.table_name %>"><%= td.table_name.humanize %></option>
        <% end %>
      </select>
    </div>

    <!-- 2) Select Sub Table (optional) -->
    <div>
      <label for="sub_table_select" class="block text-sm font-medium">Select Sub Table (optional)</label>
      <select id="sub_table_select"
              class="mt-1 block w-full border-gray-300 rounded"
              disabled
              onchange="syncFinalTableName()">
        <option value="">-- Choose a Sub Table --</option>
      </select>
    </div>

    <!-- The rest of your "Add Feature" fields (Feature Name, Type, etc.) -->
    <div>
      <label for="column_name" class="block text-sm font-medium">Feature Name</label>
      <input type="text" id="column_name" name="column_name" required
             placeholder="e.g., category"
             class="mt-1 block w-full border-gray-300 rounded">
    </div>

    <div>
      <label for="column_type" class="block text-sm font-medium">Feature Type</label>
      <select id="column_type" name="column_type"
              class="mt-1 block w-full border-gray-300 rounded">
        <option value="string">String</option>
        <option value="integer">Integer</option>
        <option value="boolean">Boolean</option>
        <option value="decimal">Decimal</option>
        <option value="text">Text</option>
        <option value="text[]">Text Array</option>
        <option value="date">Date</option>
      </select>
    </div>

    <!-- Front-end Feature (combobox, checkboxes, etc.) -->
    <div>
      <label for="feature" class="block text-sm font-medium">Front-end Feature <span class="text-gray-500">(optional)</span></label>
      <select id="feature" name="feature" class="mt-1 block w-full border-gray-300 rounded">
        <option value="">None</option>
        <option value="combobox">Combobox</option>
        <option value="checkboxes">Checkboxes</option>
      </select>
    </div>

    <!-- Example: additional fields for combobox values, cost, etc. as you already have -->
    <!-- ... -->

    <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
      Add Feature
    </button>
  </form>
</section>
    <% else %>
      <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700">
        <p>Please select a Project, Discipline, System, and Subsystem first.</p>
      </div>
    <% end %>

    <!-- Existing Columns Table -->
    <% if @table_name.present? %>
      <section class="mt-8">
        <h3 class="text-lg font-semibold">Existing Features in <%= @table_name.humanize %></h3>
        <% if @existing_columns.any? %>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 mt-4">
              <thead class="bg-indigo-600 text-white">
                <tr>
                  <th class="px-6 py-3">Feature Name</th>
                  <th class="px-6 py-3">Type</th>
                  <th class="px-6 py-3">Metadata</th>
                  <th class="px-6 py-3">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @existing_columns.each do |col| %>
                  <tr>
                    <td class="px-6 py-4"><%= col[:name] %></td>
                    <td class="px-6 py-4"><%= col[:type] %></td>
                    <td class="px-6 py-4"><%= col[:metadata] ? "Set" : "Not Set" %></td>
                    <td class="px-6 py-4">
                      <%= link_to "Edit Metadata", edit_metadata_dynamic_tables_path(
                        table_name: @table_name,
                        column_name: col[:name],
                        project_filter: @project_filter,
                        project_scope_filter: @project_scope_filter,
                        system_filter: @system_filter,
                        subsystem_filter: @subsystem_filter
                      ), class: "text-indigo-600 hover:text-indigo-800" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="mt-4 text-sm text-gray-500">No features found for this table.</p>
        <% end %>
      </section>
    <% end %>
  </div>

  <!-- JavaScript for toggling sections and dynamic row addition -->
  <script>
  // 1) Load sub-tables from the server via AJAX, populating #sub_table_select
  function loadSubTables(parentTableName) {
    const subTableSelect = document.getElementById('sub_table_select');
    // Reset sub table dropdown
    subTableSelect.innerHTML = '<option value="">-- Choose a Sub Table --</option>';
    subTableSelect.disabled = true;

    if (!parentTableName) {
      // No main table chosen => no sub-tables
      return;
    }

    fetch(`/admin/sub_tables?parent_table=${encodeURIComponent(parentTableName)}`)
      .then(response => response.json())
      .then(data => {
        // data should be an array of TableDefinition records
        data.forEach(tableDef => {
          const option = document.createElement('option');
          // e.g. "supplier_data" => "Supplier data"
          const humanized = tableDef.table_name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          option.value = tableDef.table_name;
          option.text = humanized;
          subTableSelect.appendChild(option);
        });
        // Enable if we have sub-tables
        if (data.length > 0) {
          subTableSelect.disabled = false;
        }
      });
  }

  // 2) Whenever main table or sub table changes, update the final_table_name field
  function syncFinalTableName() {
    const parentTableSelect = document.getElementById('parent_table_select');
    const subTableSelect    = document.getElementById('sub_table_select');
    const finalTableInput   = document.getElementById('final_table_name');

    // If the user has chosen a sub table, use that. Otherwise, use the parent table.
    if (subTableSelect.value) {
      finalTableInput.value = subTableSelect.value;
    } else {
      finalTableInput.value = parentTableSelect.value;
    }
  }
</script>
</body>
</html>
