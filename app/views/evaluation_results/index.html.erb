<h1 class="text-2xl font-semibold mb-6">
  Evaluation Results for
  <span class="text-indigo-600"><%= @supplier.supplier_name %></span>
  /
  <span class="text-indigo-600"><%= @subsystem.name %></span>
</h1>

<div class="mb-6 flex space-x-3">
  <%=
    button_to "Re-Evaluate Now",
    evaluate_evaluation_results_path(
      supplier_id:  @supplier.id,
      subsystem_id: @subsystem.id
    ),
    method: :post,
    class: "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
  %>

  <%=
    link_to "Download Excel",
    download_evaluation_results_path(
      supplier_id:  @supplier.id,
      subsystem_id: @subsystem.id
    ),
    class: "px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition"
  %>
</div>

<table class="w-full border-collapse border border-gray-300 text-sm">
  <thead>
    <tr class="bg-gray-100">
      <th class="border border-gray-300 px-3 py-2 text-left">Attribute</th>
      <th class="border border-gray-300 px-3 py-2 text-right">Submitted</th>
      <th class="border border-gray-300 px-3 py-2 text-right">Required</th>
      <th class="border border-gray-300 px-3 py-2 text-right">Tolerance</th>
      <th class="border border-gray-300 px-3 py-2 text-right">Degree</th>
      <th class="border border-gray-300 px-3 py-2 text-center">Status</th>
      <th class="border border-gray-300 px-3 py-2 text-center">Case</th>
      <th class="border border-gray-300 px-3 py-2 text-left">Logic</th>
    </tr>
  </thead>
  <tbody>
    <% @results.each do |r| %>
      <% row_bg = r.status == 'pass' ? 'bg-green-50' : 'bg-red-50' %>
      <tr class="<%= row_bg %>">
        <!-- Attribute -->
        <td class="border border-gray-300 px-3 py-2">
          <%= "#{r.table_name}.#{r.column_name}" %>
        </td>

        <!-- Submitted -->
        <td class="border border-gray-300 px-3 py-2 text-right">
          <%= r.submitted_value %>
        </td>

        <!-- Required -->
        <td class="border border-gray-300 px-3 py-2 text-right">
          <% md = @column_metadatas["#{r.table_name}.#{r.column_name}"] %>
          <% if md %>
            <% if md.feature == 'combobox' %>
              <% combo_stds = md.options['combo_standards'] || {} %>
              <% pass_cases = %w[Case 03 Case 04 Case 05] %>
              <% required_vals = combo_stds.select { |key, value| value.is_a?(Hash) && pass_cases.include?(value['case'].to_s.strip) }.keys %>
              <% Rails.logger.info "Combo standards for #{r.table_name}.#{r.column_name}: #{combo_stds.inspect}" %>
              <% Rails.logger.info "Required values for #{r.table_name}.#{r.column_name}: #{required_vals.inspect}" %>
              <%= required_vals.any? ? required_vals.join(', ') : '—' %>
            <% elsif md.feature == 'checkboxes' %>
              <% mandatory_vals = Array(md.options['mandatory_values']) %>
              <%= mandatory_vals.any? ? mandatory_vals.join(', ') : '—' %>
            <% else %>
              <%= r.standard_value.presence || '—' %>
            <% end %>
          <% else %>
            <% Rails.logger.info "No metadata found for #{r.table_name}.#{r.column_name}" %>
            <%= '—' %>
          <% end %>
        </td>

        <!-- Tolerance -->
        <td class="border border-gray-300 px-3 py-2 text-right">
          <%= r.tolerance.presence || '—' %>
        </td>

        <!-- Degree -->
        <td class="border border-gray-300 px-3 py-2 text-right">
          <%= r.degree %>
        </td>

        <!-- Status -->
        <td
          class="border border-gray-300 px-3 py-2 text-center uppercase font-medium"
        >
          <%= r.status %>
        </td>

        <!-- Case -->
        <td class="border border-gray-300 px-3 py-2 text-center">
          <%= r.combo_case %>
        </td>

        <!-- Logic -->
        <td class="border border-gray-300 px-3 py-2">
          <%= r.combo_logic %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
